Debian #308825; don't close all descriptors before starting the slave.

XXX needs to be clarified and perhaps merged upstream

Index: mdm-2.20.0/daemon/display.c
===================================================================
--- mdm-2.20.0.orig/daemon/display.c	2007-09-17 16:45:50.000000000 +0200
+++ mdm-2.20.0/daemon/display.c	2007-10-06 16:22:16.537644959 +0200
@@ -387,8 +387,17 @@
 
 	mdm_log_shutdown ();
 
-	/* Close everything */
-	mdm_close_all_descriptors (0 /* from */, fds[0] /* except */, slave_fifo_pipe_fd /* except2 */);
+	/* Debian changes */
+#if 0
+	/* upstream version */
+-	/* Close everything */
+-	mdm_close_all_descriptors (0 /* from */, fds[0] /* except */, slave_fifo_pipe_fd /* except2 */);
+#endif
+	/* Close stdin/stdout/stderr.  Leave others, as pam modules may have them open */
+	VE_IGNORE_EINTR (close (0));
+	VE_IGNORE_EINTR (close (1));
+	VE_IGNORE_EINTR (close (2));
+	/* End of Debian changes */
 
 	/* No error checking here - if it's messed the best response
          * is to ignore & try to continue */
Index: mdm-2.20.0/daemon/slave.c
===================================================================
--- mdm-2.20.0.orig/daemon/slave.c	2007-09-17 16:45:50.000000000 +0200
+++ mdm-2.20.0/daemon/slave.c	2007-10-06 16:22:16.541645187 +0200
@@ -1745,6 +1745,9 @@
 
 	mdm_log_shutdown ();
 
+	/* Debian changes */
+#if 0
+	/* upstream version */
 	mdm_close_all_descriptors (0 /* from */, p[1] /* except */, -1 /* except2 */);
 
 	/* No error checking here - if it's messed the best response
@@ -1752,6 +1755,17 @@
 	mdm_open_dev_null (O_RDONLY); /* open stdin - fd 0 */
 	mdm_open_dev_null (O_RDWR); /* open stdout - fd 1 */
 	mdm_open_dev_null (O_RDWR); /* open stderr - fd 2 */
+#endif
+	/* Leave stderr open to the log */
+	VE_IGNORE_EINTR (close (0));
+	VE_IGNORE_EINTR (close (1));
+	mdm_close_all_descriptors (3 /* from */, p[1] /* except */, -1 /* except2 */);
+
+	/* No error checking here - if it's messed the best response
+         * is to ignore & try to continue */
+	mdm_open_dev_null (O_RDONLY); /* open stdin - fd 0 */
+	mdm_open_dev_null (O_RDWR); /* open stdout - fd 1 */
+	/* End of Debian changes */
 
 	mdm_log_init ();
 
@@ -1912,6 +1926,9 @@
 
 		mdm_log_shutdown ();
 
+		/* Debian changes */
+#if 0
+		/* upstream version */
 		mdm_close_all_descriptors (0 /* from */, slave_fifo_pipe_fd /* except */, d->slave_notify_fd /* except2 */);
 
 		/* No error checking here - if it's messed the best response
@@ -1919,6 +1936,17 @@
 		mdm_open_dev_null (O_RDONLY); /* open stdin - fd 0 */
 		mdm_open_dev_null (O_RDWR); /* open stdout - fd 1 */
 		mdm_open_dev_null (O_RDWR); /* open stderr - fd 2 */
+#endif
+		/* Leave stderr open to the log */
+		VE_IGNORE_EINTR (close (0));
+		VE_IGNORE_EINTR (close (1));
+		mdm_close_all_descriptors (3 /* from */, slave_fifo_pipe_fd /* except */, d->slave_notify_fd /* except2 */);
+
+		/* No error checking here - if it's messed the best response
+		 * is to ignore & try to continue */
+		mdm_open_dev_null (O_RDONLY); /* open stdin - fd 0 */
+		mdm_open_dev_null (O_RDWR); /* open stdout - fd 1 */
+		/* End of Debian changes */
 
 		mdm_log_init ();
 
